CREATE PROCEDURE Alm_PutPricesForVTEXRequest (@Limit int) AS


SELECT TOP (@Limit)
	USR_STMPDH_IDSKUVTEX Id, 
	
	ISNULL((SELECT TOP (1) CAST(FLOOR(ROUND(STTPRE_PRECIO * 
		 (CASE STMPDH_CODCPT WHEN 'V001' THEN 1.21 WHEN 'V002' THEN 1.105 WHEN 'V000' THEN 1 ELSE 0 END), 2)) AS FLOAT) AS Expr1
		  FROM  STTPRE
		  INNER JOIN STTLPR ON 
		  STTLPR_CODLIS = STTPRE_CODLIS
		  WHERE (STTPRE_CODLIS = '01') 
		  AND (STTPRE_TIPPRO = STMPDH.STMPDH_TIPPRO) 
		  AND (STTPRE_ARTCOD = STMPDH.STMPDH_ARTCOD) 
		  AND (STTPRE_FECLIS <= GETDATE())
		  ORDER BY STTPRE_FECLIS DESC), 0.00) basePrice,
	
	ISNULL((SELECT TOP (1) CAST(FLOOR(ROUND(STTPRE_PRECIO *                                                
		 (CASE STMPDH_CODCPT WHEN 'V001' THEN 1.21 WHEN 'V002' THEN 1.105 WHEN 'V000' THEN 1 ELSE 0 END), 2)) AS FLOAT) AS Expr1
		  FROM  STTPRE
		  INNER JOIN STTLPR ON 
		  STTLPR_CODLIS = STTPRE_CODLIS
		  WHERE (STTPRE_CODLIS = '01') 
		  AND (STTPRE_TIPPRO = STMPDH.STMPDH_TIPPRO) 
		  AND (STTPRE_ARTCOD = STMPDH.STMPDH_ARTCOD) 
		  AND (STTPRE_FECLIS <= GETDATE())
		  ORDER BY STTPRE_FECLIS DESC), 0.00)  listPrice,

		ISNULL((SELECT TOP (1) CAST(FLOOR(ROUND(STTPRE_PRECIO *                                                
		 (CASE STMPDH_CODCPT WHEN 'V001' THEN 1.21 WHEN 'V002' THEN 1.105 WHEN 'V000' THEN 1 ELSE 0 END), 2)) AS FLOAT) AS Expr1
		  FROM  STTPRE
		  INNER JOIN STTLPR ON 
		  STTLPR_CODLIS = STTPRE_CODLIS
		  WHERE (STTPRE_CODLIS = '01') 
		  AND (STTPRE_TIPPRO = STMPDH.STMPDH_TIPPRO) 
		  AND (STTPRE_ARTCOD = STMPDH.STMPDH_ARTCOD) 
		  AND (STTPRE_FECLIS <= GETDATE())
		  ORDER BY STTPRE_FECLIS DESC), 0.00) costPrice
FROM STMPDH
	
WHERE
	ISNULL((SELECT TOP (1) CAST(FLOOR(ROUND(STTPRE_PRECIO * 
                                               
		 (CASE STMPDH_CODCPT WHEN 'V001' THEN 1.21 WHEN 'V002' THEN 1.105 WHEN 'V000' THEN 1 ELSE 0 END), 2)) AS DECIMAL(10, 2)) AS Expr1
		  FROM  STTPRE
		  INNER JOIN STTLPR ON 
		  STTLPR_CODLIS = STTPRE_CODLIS
		  WHERE (STTPRE_CODLIS = '01') 
		  AND (STTPRE_TIPPRO = STMPDH.STMPDH_TIPPRO) 
		  AND (STTPRE_ARTCOD = STMPDH.STMPDH_ARTCOD) 
		  AND (STTPRE_FECLIS <= GETDATE())
		  ORDER BY STTPRE_FECLIS DESC), 0.00)  <> 0 AND
	USR_STMPDH_IDSKUVTEX <> 0 AND 
	isnull(USR_VTEX_PRETRA,'N') = 'N'



	

